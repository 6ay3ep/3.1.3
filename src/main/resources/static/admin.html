<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <!-- Bootstrap CSS -->
    <script>
        // Получение CSRF токена
        function getCSRFToken() {
            return document.querySelector('meta[name="_csrf"]').content;
        }
    </script>
</head>
<body>
<!-- Навигационная панель -->
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
            <span class="navbar-text text-white">
                Logged as: <span id="currentUser"></span>
                Roles: <span id="currentRoles"></span>
            </span>
        <button class="btn btn-outline-light" id="logoutBtn">Logout</button>
    </div>
</nav>

<!-- Основной контент -->
<div class="container mt-4">
    <h1>Admin Panel</h1>

    <!-- Таблица пользователей -->
    <table class="table table-striped">
        <thead>
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Roles</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="usersTable">
        <!-- Данные будут загружены через JS -->
        </tbody>
    </table>

    <!-- Форма добавления пользователя -->
    <div class="card mt-4">
        <div class="card-header">Add New User</div>
        <div class="card-body">
            <form id="addUserForm">
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="Username" name="username" required>
                </div>
                <div class="mb-3">
                    <input type="password" class="form-control" placeholder="Password" name="password" required>
                </div>
                <div class="mb-3">
                    <select class="form-select" name="roles" multiple required>
                        <option value="ROLE_USER">USER</option>
                        <option value="ROLE_ADMIN">ADMIN</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add User</button>
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap & jQuery -->
<script>
    $(document).ready(function() {
        const csrfToken = getCSRFToken();

        // Загрузка текущего пользователя
        function loadCurrentUser() {
            fetch('/api/user')
                .then(response => response.json())
                .then(user => {
                    $('#currentUser').text(user.username);
                    $('#currentRoles').text(user.roles.map(r => r.name.replace('ROLE_', '')).join(', '));
                });
        }

        // Загрузка всех пользователей
        function loadUsers() {
            fetch('/api/admin')
                .then(response => response.json())
                .then(users => {
                    const tableBody = $('#usersTable').empty();
                    users.forEach(user => {
                        const roles = user.roles.map(r =>
                            `<span class="badge bg-secondary">${r.name.replace('ROLE_', '')}</span>`
                        ).join(' ');

                        tableBody.append(`
                                <tr>
                                    <td>${user.id}</td>
                                    <td>${user.username}</td>
                                    <td>${roles}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning edit-btn" data-id="${user.id}">Edit</button>
                                        <button class="btn btn-sm btn-danger delete-btn" data-id="${user.id}">Delete</button>
                                    </td>
                                </tr>
                            `);
                    });

                    // Назначение обработчиков
                    $('.edit-btn').click(e => {
                        const userId = $(e.target).data('id');
                        openEditModal(userId);
                    });

                    $('.delete-btn').click(e => {
                        const userId = $(e.target).data('id');
                        deleteUser(userId);
                    });
                });
        }

        // Открытие модального окна редактирования
        function openEditModal(userId) {
            fetch(`/api/admin/${userId}`)
                .then(response => response.json())
                .then(user => {
                    // Заполнение формы редактирования
                    // ... реализация модального окна ...
                });
        }

        // Обработка добавления пользователя
        $('#addUserForm').submit(e => {
            e.preventDefault();
            const formData = {
                username: $('input[name="username"]').val(),
                password: $('input[name="password"]').val(),
                roles: $('select[name="roles"]').val()
            };

            fetch('/api/admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken
                },
                body: JSON.stringify(formData)
            })
                .then(() => {
                    loadUsers();
                    e.target.reset();
                });
        });

        // Инициализация
        loadCurrentUser();
        loadUsers();
    });
</script>
</body>
</html>